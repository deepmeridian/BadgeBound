generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum QuestType {
  ONBOARDING
  DAILY
  WEEKLY
  SEASONAL
  ACHIEVEMENT
}

enum QuestStatus {
  LOCKED
  IN_PROGRESS
  COMPLETED
  CLAIMED
  EXPIRED
}

model User {
  wallet        String       @id
  createdAt     DateTime     @default(now())
  lastSeenAt    DateTime?    
  seasonXp      Int          @default(0)
  seasonLevel   Int          @default(1)
  lifetimeXp    Int          @default(0)
  userQuests    UserQuest[]

  stats UserSeasonStats[]
}

model Protocol {
  id       Int      @id @default(autoincrement())
  slug     String   @unique
  name     String
  logoUrl  String?
  config   Json?
  quests   Quest[]
}

model Season {
  id        Int       @id @default(autoincrement())
  name      String
  slug      String    @unique // e.g. "s1-founders", "s2-saucerswap"
  startAt   DateTime?
  endAt     DateTime?
  isActive  Boolean   @default(false)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  quests    Quest[]
  stats     UserSeasonStats[]
}

model UserSeasonStats {
  id        Int      @id @default(autoincrement())
  seasonId  Int
  userWallet String

  xp        Int      @default(0)
  level     Int      @default(1)
  badges    Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  season    Season   @relation(fields: [seasonId], references: [id])
  user      User     @relation(fields: [userWallet], references: [wallet])

  @@unique([seasonId, userWallet])
}

model Quest {
  id          Int          @id @default(autoincrement())
  protocol    Protocol?    @relation(fields: [protocolId], references: [id])
  protocolId  Int?
  type        QuestType
  title       String
  description String
  startAt     DateTime?
  endAt       DateTime?
  requirement Json          // e.g. { type: "SWAP_VOLUME", poolId: "...", minVolume: 10 }
  reward      Json          // e.g. { xp: 100, badgeQuestId: 1, tokenAmount: 5 }
  seasonId    Int?
  season      Season?    @relation(fields: [seasonId], references: [id])
  isActive    Boolean       @default(true)
  userQuests  UserQuest[]
}

model UserQuest {
  id           Int         @id @default(autoincrement())
  user         User        @relation(fields: [userWallet], references: [wallet])
  userWallet   String
  quest        Quest       @relation(fields: [questId], references: [id])
  questId      Int
  status       QuestStatus @default(LOCKED)
  progressData Json?
  createdAt    DateTime    @default(now())
  lastUpdated  DateTime    @default(now())
  completedAt  DateTime?
  claimedAt    DateTime?

  @@unique([userWallet, questId])
}